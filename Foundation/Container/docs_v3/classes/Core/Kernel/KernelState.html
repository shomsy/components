<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>KernelState</title>
    <link href="../../../styles.css" rel="stylesheet">
</head>
<body>
<div class="layout">
                        <aside class="sidebar">
        <div class="brand"><a href="../../../index.html">Container Docs</a></div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search...">
        </div>
        <nav>
            <div class="nav-section">
                <h3 class="nav-title">Container (Root)</h3>
                <ul class="nav-list">
                    <li><a href="../../Container.html">Container</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Act/Inject</h3>
                <ul class="nav-list">
                    <li><a href="../../Act/Inject/InjectDependencies.html">InjectDependencies</a></li>
                    <li><a href="../../Act/Inject/PropertyInjector.html">PropertyInjector</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Actions/Advanced/Lazy</h3>
                <ul class="nav-list">
                    <li><a href="../../Actions/Advanced/Lazy/LazyInterface.html">LazyInterface</a></li>
                    <li><a href="../../Actions/Advanced/Lazy/LazyValue.html">LazyValue</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Actions/Inject</h3>
                <ul class="nav-list">
                    <li><a href="../../Actions/Inject/InjectDependencies.html">InjectDependencies</a></li>
                    <li><a href="../../Actions/Inject/PropertyInjector.html">PropertyInjector</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Actions/Inject/Resolvers</h3>
                <ul class="nav-list">
                    <li><a href="../../Actions/Inject/Resolvers/PropertyResolution.html">PropertyResolution</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Actions/Instantiate</h3>
                <ul class="nav-list">
                    <li><a href="../../Actions/Instantiate/Instantiator.html">Instantiator</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Actions/Invoke/Cache</h3>
                <ul class="nav-list">
                    <li><a href="../../Actions/Invoke/Cache/ReflectionCache.html">ReflectionCache</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Advanced/Lazy</h3>
                <ul class="nav-list">
                    <li><a href="../../Advanced/Lazy/LazyInterface.html">LazyInterface</a></li>
                    <li><a href="../../Advanced/Lazy/LazyValue.html">LazyValue</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Advanced/Observe</h3>
                <ul class="nav-list">
                    <li><a href="../../Advanced/Observe/DiagnosticsFlow.html">DiagnosticsFlow</a></li>
                    <li><a href="../../Advanced/Observe/Telemetry.html">Telemetry</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Advanced/Policy</h3>
                <ul class="nav-list">
                    <li><a href="../../Advanced/Policy/PolicyFlow.html">PolicyFlow</a></li>
                    <li><a href="../../Advanced/Policy/Security.html">Security</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core</h3>
                <ul class="nav-list">
                    <li><a href="../Container.html">Container</a></li>
                    <li><a href="../ContainerBuilder.html">ContainerBuilder</a></li>
                    <li><a href="../ContainerConfig.html">ContainerConfig</a></li>
                    <li><a href="../ContainerEngine.html">ContainerEngine</a></li>
                    <li><a href="../ContainerKernel.html">ContainerKernel</a></li>
                    <li><a href="../ResolutionEngine.html">ResolutionEngine</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Attribute</h3>
                <ul class="nav-list">
                    <li><a href="../Attribute/Inject.html">Inject</a></li>
                    <li><a href="../Attribute/Singleton.html">Singleton</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/DTO</h3>
                <ul class="nav-list">
                    <li><a href="../DTO/ErrorDTO.html">ErrorDTO</a></li>
                    <li><a href="../DTO/InjectionReport.html">InjectionReport</a></li>
                    <li><a href="../DTO/SuccessDTO.html">SuccessDTO</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Enum</h3>
                <ul class="nav-list">
                    <li><a href="../Enum/ServiceLifetime.html">ServiceLifetime</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Exceptions</h3>
                <ul class="nav-list">
                    <li><a href="../Exceptions/ContainerExceptions.html">ContainerExceptions</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Kernel</h3>
                <ul class="nav-list">
                    <li><a href="KernelCompiler.html">KernelCompiler</a></li>
                    <li><a href="KernelConfig.html">KernelConfig</a></li>
                    <li><a href="KernelFacade.html">KernelFacade</a></li>
                    <li><a href="KernelRuntime.html">KernelRuntime</a></li>
                    <li><a href="KernelState.html">KernelState</a></li>
                    <li><a href="LifecycleResolver.html">LifecycleResolver</a></li>
                    <li><a href="LifecycleStrategyRegistry.html">LifecycleStrategyRegistry</a></li>
                    <li><a href="ResolutionPipeline.html">ResolutionPipeline</a></li>
                    <li><a href="ResolutionPipelineBuilder.html">ResolutionPipelineBuilder</a></li>
                    <li><a href="StepTelemetryCollector.html">StepTelemetryCollector</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Kernel/Contracts</h3>
                <ul class="nav-list">
                    <li><a href="Contracts/KernelContext.html">KernelContext</a></li>
                    <li><a href="Contracts/KernelStep.html">KernelStep</a></li>
                    <li><a href="Contracts/LifecycleStrategy.html">LifecycleStrategy</a></li>
                    <li><a href="Contracts/StepTelemetry.html">StepTelemetry</a></li>
                    <li><a href="Contracts/TerminalKernelStep.html">TerminalKernelStep</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Kernel/Events</h3>
                <ul class="nav-list">
                    <li><a href="Events/StepFailed.html">StepFailed</a></li>
                    <li><a href="Events/StepStarted.html">StepStarted</a></li>
                    <li><a href="Events/StepSucceeded.html">StepSucceeded</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Kernel/Steps</h3>
                <ul class="nav-list">
                    <li><a href="Steps/AnalyzePrototypeStep.html">AnalyzePrototypeStep</a></li>
                    <li><a href="Steps/ApplyExtendersStep.html">ApplyExtendersStep</a></li>
                    <li><a href="Steps/CircularDependencyStep.html">CircularDependencyStep</a></li>
                    <li><a href="Steps/CollectDiagnosticsStep.html">CollectDiagnosticsStep</a></li>
                    <li><a href="Steps/DepthGuardStep.html">DepthGuardStep</a></li>
                    <li><a href="Steps/EnsureDefinitionExistsStep.html">EnsureDefinitionExistsStep</a></li>
                    <li><a href="Steps/GuardPolicyStep.html">GuardPolicyStep</a></li>
                    <li><a href="Steps/InjectDependenciesStep.html">InjectDependenciesStep</a></li>
                    <li><a href="Steps/InvokePostConstructStep.html">InvokePostConstructStep</a></li>
                    <li><a href="Steps/ResolveInstanceStep.html">ResolveInstanceStep</a></li>
                    <li><a href="Steps/RetrieveFromScopeStep.html">RetrieveFromScopeStep</a></li>
                    <li><a href="Steps/StoreLifecycleStep.html">StoreLifecycleStep</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Kernel/Strategies</h3>
                <ul class="nav-list">
                    <li><a href="Strategies/ScopedLifecycleStrategy.html">ScopedLifecycleStrategy</a></li>
                    <li><a href="Strategies/SingletonLifecycleStrategy.html">SingletonLifecycleStrategy</a></li>
                    <li><a href="Strategies/TransientLifecycleStrategy.html">TransientLifecycleStrategy</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Core/Utils</h3>
                <ul class="nav-list">
                    <li><a href="../Utils/ArrayTools.html">ArrayTools</a></li>
                    <li><a href="../Utils/StrTools.html">StrTools</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Define/Bind</h3>
                <ul class="nav-list">
                    <li><a href="../../Define/Bind/BindingBuilder.html">BindingBuilder</a></li>
                    <li><a href="../../Define/Bind/ContextBuilder.html">ContextBuilder</a></li>
                    <li><a href="../../Define/Bind/Registrar.html">Registrar</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Define/Store</h3>
                <ul class="nav-list">
                    <li><a href="../../Define/Store/DefinitionStore.html">DefinitionStore</a></li>
                    <li><a href="../../Define/Store/ServiceDefinition.html">ServiceDefinition</a></li>
                    <li><a href="../../Define/Store/ServiceDefinitionEntity.html">ServiceDefinitionEntity</a></li>
                    <li><a href="../../Define/Store/ServiceDiscovery.html">ServiceDiscovery</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Define/Store/Compiler</h3>
                <ul class="nav-list">
                    <li><a href="../../Define/Store/Compiler/CompilerPassInterface.html">CompilerPassInterface</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Invoke</h3>
                <ul class="nav-list">
                    <li><a href="../../Invoke/InvocationExecutor.html">InvocationExecutor</a></li>
                    <li><a href="../../Invoke/InvokeAction.html">InvokeAction</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Invoke/Cache</h3>
                <ul class="nav-list">
                    <li><a href="../../Invoke/Cache/ReflectionCache.html">ReflectionCache</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Invoke/Context</h3>
                <ul class="nav-list">
                    <li><a href="../../Invoke/Context/InvocationContext.html">InvocationContext</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Operate</h3>
                <ul class="nav-list">
                    <li><a href="../../Operate/ScopeManager.html">ScopeManager</a></li>
                    <li><a href="../../Operate/ScopeRegistry.html">ScopeRegistry</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Operate/Boot</h3>
                <ul class="nav-list">
                    <li><a href="../../Operate/Boot/Application.html">Application</a></li>
                    <li><a href="../../Operate/Boot/ApplicationBuilder.html">ApplicationBuilder</a></li>
                    <li><a href="../../Operate/Boot/ContainerBootstrapper.html">ContainerBootstrapper</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Operate/Config</h3>
                <ul class="nav-list">
                    <li><a href="../../Operate/Config/BootstrapProfile.html">BootstrapProfile</a></li>
                    <li><a href="../../Operate/Config/ContainerConfig.html">ContainerConfig</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Operate/Scope</h3>
                <ul class="nav-list">
                    <li><a href="../../Operate/Scope/ScopeManager.html">ScopeManager</a></li>
                    <li><a href="../../Operate/Scope/ScopeRegistry.html">ScopeRegistry</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Operate/Shutdown</h3>
                <ul class="nav-list">
                    <li><a href="../../Operate/Shutdown/TerminateContainer.html">TerminateContainer</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Resolve</h3>
                <ul class="nav-list">
                    <li><a href="../../Resolve/DependencyResolver.html">DependencyResolver</a></li>
                    <li><a href="../../Resolve/ResolutionContext.html">ResolutionContext</a></li>
                    <li><a href="../../Resolve/ResolutionEngine.html">ResolutionEngine</a></li>
                    <li><a href="../../Resolve/ResolutionPipeline.html">ResolutionPipeline</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Resolve/Pipes</h3>
                <ul class="nav-list">
                    <li><a href="../../Resolve/Pipes/AutowirePipe.html">AutowirePipe</a></li>
                    <li><a href="../../Resolve/Pipes/BindingPipe.html">BindingPipe</a></li>
                    <li><a href="../../Resolve/Pipes/ScopePipe.html">ScopePipe</a></li>
                    <li><a href="../../Resolve/Pipes/TerminalPipe.html">TerminalPipe</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Resolve/Resolvers</h3>
                <ul class="nav-list">
                    <li><a href="../../Resolve/Resolvers/DefaultResolver.html">DefaultResolver</a></li>
                    <li><a href="../../Resolve/Resolvers/ExceptionResolver.html">ExceptionResolver</a></li>
                    <li><a href="../../Resolve/Resolvers/NullResolver.html">NullResolver</a></li>
                    <li><a href="../../Resolve/Resolvers/OverrideResolver.html">OverrideResolver</a></li>
                    <li><a href="../../Resolve/Resolvers/ParameterResolutionChain.html">ParameterResolutionChain</a></li>
                    <li><a href="../../Resolve/Resolvers/ParameterResolver.html">ParameterResolver</a></li>
                    <li><a href="../../Resolve/Resolvers/TypeResolver.html">TypeResolver</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Think/Analyze</h3>
                <ul class="nav-list">
                    <li><a href="../../Think/Analyze/PrototypeAnalyzer.html">PrototypeAnalyzer</a></li>
                    <li><a href="../../Think/Analyze/ReflectionTypeAnalyzer.html">ReflectionTypeAnalyzer</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Think/Cache</h3>
                <ul class="nav-list">
                    <li><a href="../../Think/Cache/FilePrototypeCache.html">FilePrototypeCache</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Think/Model</h3>
                <ul class="nav-list">
                    <li><a href="../../Think/Model/MethodPrototype.html">MethodPrototype</a></li>
                    <li><a href="../../Think/Model/ParameterPrototype.html">ParameterPrototype</a></li>
                    <li><a href="../../Think/Model/PropertyPrototype.html">PropertyPrototype</a></li>
                    <li><a href="../../Think/Model/ServicePrototype.html">ServicePrototype</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Think/Prototype</h3>
                <ul class="nav-list">
                    <li><a href="../../Think/Prototype/ServicePrototypeFactory.html">ServicePrototypeFactory</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Think/Prototype/Contracts</h3>
                <ul class="nav-list">
                    <li><a href="../../Think/Prototype/Contracts/ServicePrototypeFactoryInterface.html">ServicePrototypeFactoryInterface</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Think/Verify</h3>
                <ul class="nav-list">
                    <li><a href="../../Think/Verify/VerifyPrototype.html">VerifyPrototype</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-title">Guidelines</h3>
                <ul class="nav-list">
                    <li><a href="../../../master-prompt.html">Master Prompt</a></li>
                </ul>
            </div>
        </nav>
    </aside>
    <main class="content">
        <section class="hero">
            <h1>KernelState</h1>
            <p>Lazy Instance Management for Runtime Flows</p>
            <div class="meta">Foundation/Container/Core/Kernel/KernelState.php</div>
        </section>

        <section class="section">
            <h2>Class Overview</h2>
            <div class="card">
                <p>KernelState implements the lazy initialization pattern for managing kernel components that are expensive to create or should be instantiated only when needed. It provides a simple mechanism for deferring object creation until the first access.</p>
                <details class="more">
                    <summary>More</summary>
                    <p><strong>WHY IT EXISTS:</strong></p>
                    <p>- To defer expensive object creation until actually needed</p>
                    <p>- To reduce kernel initialization time and memory usage</p>
                    <p>- To provide a consistent pattern for optional kernel components</p>
                    <p>- To enable conditional component loading based on usage</p>
                    <p><strong>HOW IT WORKS:</strong></p>
                    <p>The class maintains properties that start as null. When accessed, if the value is null, a factory function is called to create the actual instance, which is then cached for future use.</p>
                    <p><strong>LAZY INITIALIZATION PATTERN:</strong></p>
                    <p>Instead of creating all components at startup:</p>
                    <p><code>$expensive = new ExpensiveComponent();</code></p>
                    <p>It defers creation:</p>
                    <p><code>$expensive = $state->getOrInit('telemetry', fn() => new Telemetry(...))</code></p>
                </details>
            </div>
        </section>

        <section class="section">
            <h2>Lazy Initialization Pattern</h2>

            <div class="card">
                <h3>Basic Usage in Kernel</h3>
                <pre><code class="language-php">// Kernel uses lazy initialization for expensive components
class ContainerKernel {
    private KernelState $state;

    public function __construct() {
        $this->state = new KernelState();
    }

    public function telemetry(): Telemetry {
        // Only creates Telemetry when first accessed
        return $this->state->getOrInit('telemetry', function() {
            return new Telemetry($this, $this->config->metrics);
        });
    }
}

// First call creates and caches the instance
$telemetry = $kernel->telemetry(); // ← Creates Telemetry

// Subsequent calls return cached instance
$sameTelemetry = $kernel->telemetry(); // ← Returns cached instance</code></pre>
            </div>

            <div class="card">
                <h3>Application-Level Lazy Loading</h3>
                <pre><code class="language-php">// Application can use similar pattern for expensive services
class Application {
    private array $lazyServices = [];

    public function getExpensiveService(): ExpensiveService {
        return $this->lazyServices['expensive'] ??= $this->createExpensiveService();
    }

    private function createExpensiveService(): ExpensiveService {
        // Heavy initialization only happens here
        return new ExpensiveService(
            $this->loadConfiguration(),
            $this->connectToDatabase(),
            $this->initializeCache()
        );
    }
}</code></pre>
            </div>

            <div class="card">
                <h3>Testing with State Reset</h3>
                <pre><code class="language-php">// Tests can reset state between runs
class KernelTest extends TestCase {
    private ContainerKernel $kernel;
    private KernelState $state;

    protected function setUp(): void {
        $this->kernel = $this->createKernel();
        $this->state = $this->kernel->getState();
    }

    public function testTelemetryIsolation(): void {
        // First test
        $telemetry1 = $this->kernel->telemetry();
        $this->assertInstanceOf(Telemetry::class, $telemetry1);

        // Reset state between tests
        $this->state->reset();

        // Second test gets fresh instance
        $telemetry2 = $this->kernel->telemetry();
        $this->assertNotSame($telemetry1, $telemetry2);
    }
}</code></pre>
            </div>
        </section>

        <section class="section">
            <h2>Methods</h2>

            <div class="card" id="getOrInit">
                <h3>getOrInit</h3>
                <p>Get or initialize a flow instance using the provided factory.</p>
                <details class="more">
                    <summary>More</summary>
                    <p><strong>WHY IT EXISTS:</strong></p>
                    <p>- To implement the core lazy initialization logic</p>
                    <p>- To provide thread-safe property access with factories</p>
                    <p>- To centralize the lazy loading pattern used throughout the kernel</p>
                    <p><strong>HOW IT WORKS:</strong></p>
                    <p>1. <strong>Validate Property</strong>: Ensures the property name exists on the class</p>
                    <p>2. <strong>Check Cache</strong>: Returns existing value if already initialized</p>
                    <p>3. <strong>Execute Factory</strong>: Calls the factory function to create the instance</p>
                    <p>4. <strong>Cache Result</strong>: Stores the created instance for future access</p>
                    <p><strong>PROPERTY VALIDATION:</strong></p>
                    <p>Uses <code>property_exists()</code> to ensure only declared properties can be lazy-loaded:</p>
                    <p><code>if (!property_exists($this, $property))</code></p>
                    <p>This prevents typos and ensures type safety.</p>
                    <p><strong>FACTORY PATTERN:</strong></p>
                    <p>The factory closure allows complex initialization logic:</p>
                    <p><code>fn() => new Telemetry($kernel, $metrics)</code></p>
                    <p>This can include dependency injection, configuration, and setup.</p>
                    <p><strong>ERROR HANDLING:</strong></p>
                    <p>Throws <code>InvalidArgumentException</code> for unknown properties to catch configuration errors early.</p>
                </details>
            </div>

            <div class="card" id="reset">
                <h3>reset</h3>
                <p>Reset all lazy-initialized state to null.</p>
                <details class="more">
                    <summary>More</summary>
                    <p><strong>WHY IT EXISTS:</strong></p>
                    <p>- To provide a way to clear cached instances</p>
                    <p>- To enable testing with fresh component instances</p>
                    <p>- To support state reset in long-running applications</p>
                    <p>- To recover from corrupted lazy-initialized state</p>
                    <p><strong>WHAT IT DOES:</strong></p>
                    <p>Resets all lazy properties to null:</p>
                    <p><code>$this->telemetry = null;</code></p>
                    <p>This forces re-initialization on next access.</p>
                    <p><strong>WHEN TO USE:</strong></p>
                    <p>- <strong>Testing</strong>: Between test methods to ensure isolation</p>
                    <p>- <strong>Development</strong>: When reloading code changes</p>
                    <p>- <strong>Debugging</strong>: To force fresh component creation</p>
                    <p>- <strong>Memory Management</strong>: In long-running processes to free cached objects</p>
                    <p><strong>PERFORMANCE IMPACT:</strong></p>
                    <p>- Next access will be slower due to re-initialization</p>
                    <p>- Memory usage decreases temporarily</p>
                    <p>- Useful for memory-constrained environments</p>
                </details>
            </div>
        </section>

        <section class="section">
            <h2>Lazy Loading Benefits</h2>
            <div class="card">
                <p><strong>Performance:</strong> Components are only created when actually needed, reducing startup time and memory usage.</p>
                <p><strong>Flexibility:</strong> Optional components can be loaded conditionally based on application needs.</p>
                <p><strong>Testability:</strong> State can be reset between tests to ensure proper isolation.</p>
                <p><strong>Error Handling:</strong> Failures in component creation don't prevent kernel initialization.</p>
            </div>
        </section>
    </main>
</div>
</body>
</html>